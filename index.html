<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WebRTC メッセージアプリ</title>
<style>
body { font-family: -apple-system, sans-serif; margin:12px; }
textarea, input[type=text], input[type=file] { width:100%; margin-top:4px; margin-bottom:6px; }
#chat { height:200px; overflow:auto; border:1px solid #ccc; padding:6px; }
#log { background:#f0f0f0; height:150px; overflow:auto; padding:6px; margin-top:6px; }
button { margin-top:4px; }
</style>
</head>
<body>
<h2>WebRTC メッセージアプリ（テスト用）</h2>

<label>自分のSDP（初回接続用）</label>
<textarea id="localSDP" readonly></textarea>
<button id="createOffer">Offer作成</button>

<label>相手のSDPを貼る</label>
<textarea id="remoteSDP"></textarea>
<button id="setRemote">接続開始</button>

<label>メッセージ入力</label>
<input id="msgInput" type="text">
<button id="sendBtn">送信</button>

<label>ファイル選択（送信用）</label>
<input type="file" id="fileInput">

<button id="downloadLog">チャットログをダウンロード</button>

<div id="chat"></div>
<div id="log"></div>

<script>
let pc;
let dc;

function log(msg){
  const logEl = document.getElementById('log');
  logEl.innerText += msg + "\n";
  logEl.scrollTop = logEl.scrollHeight;
}

function appendChat(from,msg){
  const chatEl = document.getElementById('chat');
  chatEl.innerHTML += "<b>"+from+"</b>: "+msg+"<br>";
  chatEl.scrollTop = chatEl.scrollHeight;
}

// Offer作成
document.getElementById('createOffer').addEventListener('click', async ()=>{
  pc = new RTCPeerConnection();

  dc = pc.createDataChannel("chat");
  dc.onmessage = e=>appendChat("相手", e.data);
  dc.onopen = ()=>log("DataChannel open");

  pc.onicecandidate = e=>{
    if(e.candidate) return;
    document.getElementById('localSDP').value = JSON.stringify(pc.localDescription);
    log("SDP作成完了。相手にコピーして渡してね。");
  }

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
});

// 相手SDP貼って接続開始
document.getElementById('setRemote').addEventListener('click', async ()=>{
  if(!pc) pc = new RTCPeerConnection();

  pc.ondatachannel = e=>{
    dc = e.channel;
    dc.onmessage = e=>appendChat("相手", e.data);
    dc.onopen = ()=>log("DataChannel open");
  }

  const remoteSDP = JSON.parse(document.getElementById('remoteSDP').value);
  await pc.setRemoteDescription(remoteSDP);

  if(remoteSDP.type === "offer"){
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    document.getElementById('localSDP').value = JSON.stringify(pc.localDescription);
    log("Answer作成完了。コピーして相手に渡してね。");
  }
});

// メッセージ送信
document.getElementById('sendBtn').addEventListener('click', ()=>{
  const msg = document.getElementById('msgInput').value;
  if(dc && dc.readyState === "open"){
    dc.send(msg);
    appendChat("自分", msg);
    document.getElementById('msgInput').value = "";
  } else {
    log("DataChannelが未接続です");
  }
});

// ファイル送信
document.getElementById('fileInput').addEventListener('change', e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(){
    const text = reader.result;
    if(dc && dc.readyState === "open"){
      dc.send("[File] "+file.name+"\n"+text);
      appendChat("自分 (file)", file.name);
    } else {
      log("DataChannelが未接続です");
    }
  }
  reader.readAsText(file);
});

// チャットログダウンロード
document.getElementById('downloadLog').addEventListener('click', ()=>{
  const chatEl = document.getElementById('chat');
  const blob = new Blob([chatEl.innerText], {type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'chat_log.txt';
  a.click();
  URL.revokeObjectURL(url);
});
</script>
</body>
</html>
