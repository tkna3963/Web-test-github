<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WebRTC ファイル接続メッセージ</title>
<style>
body { font-family: -apple-system, sans-serif; margin:12px; }
textarea, input[type=text], input[type=file] { width:100%; margin-top:4px; margin-bottom:6px; }
#chat { height:200px; overflow:auto; border:1px solid #ccc; padding:6px; }
#log { background:#f0f0f0; height:150px; overflow:auto; padding:6px; margin-top:6px; }
button { margin-top:4px; }
</style>
</head>
<body>
<h2>WebRTC ファイル接続メッセージ</h2>

<button id="createOffer">Offer作成 & ファイル保存</button>
<input type="file" id="loadSDP"> SDPファイル読み込み（Answer/Offer用）

<label>メッセージ入力</label>
<input id="msgInput" type="text">
<button id="sendBtn">送信</button>

<div id="chat"></div>
<div id="log"></div>

<script>
let pc;
let dc;

function log(msg){
  const logEl = document.getElementById('log');
  logEl.innerText += msg + "\n";
  logEl.scrollTop = logEl.scrollHeight;
}

function appendChat(from,msg){
  const chatEl = document.getElementById('chat');
  chatEl.innerHTML += "<b>"+from+"</b>: "+msg+"<br>";
  chatEl.scrollTop = chatEl.scrollHeight;
}

// Offer作成 + ファイル保存
document.getElementById('createOffer').addEventListener('click', async ()=>{
  pc = new RTCPeerConnection();

  dc = pc.createDataChannel("chat");
  dc.onmessage = e=>appendChat("相手", e.data);
  dc.onopen = ()=>log("DataChannel open");

  pc.onicecandidate = e=>{
    if(e.candidate) return;
    const sdpText = JSON.stringify(pc.localDescription);
    const blob = new Blob([sdpText], {type:'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'offer_sdp.txt';
    a.click();
    URL.revokeObjectURL(url);
    log("Offer作成完了。offer_sdp.txtを相手に渡してください。");
  }

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
});

// SDPファイル読み込み
document.getElementById('loadSDP').addEventListener('change', e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = async function(){
    const sdp = JSON.parse(reader.result);

    if(!pc) pc = new RTCPeerConnection();

    pc.ondatachannel = e=>{
      dc = e.channel;
      dc.onmessage = e=>appendChat("相手", e.data);
      dc.onopen = ()=>log("DataChannel open");
    }

    await pc.setRemoteDescription(sdp);

    if(sdp.type === "offer"){
      dc = pc.createDataChannel("chat");
      dc.onmessage = e=>appendChat("相手", e.data);
      dc.onopen = ()=>log("DataChannel open");

      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      const blob = new Blob([JSON.stringify(pc.localDescription)], {type:'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'answer_sdp.txt';
      a.click();
      URL.revokeObjectURL(url);

      log("Answer作成完了。answer_sdp.txtを相手に渡してください。");
    } else {
      log("接続完了。");
    }
  }
  reader.readAsText(file);
});

// メッセージ送信
document.getElementById('sendBtn').addEventListener('click', ()=>{
  const msg = document.getElementById('msgInput').value;
  if(dc && dc.readyState === "open"){
    dc.send(msg);
    appendChat("自分", msg);
    document.getElementById('msgInput').value = "";
  } else {
    log("DataChannelが未接続です");
  }
});
</script>
</body>
</html>
